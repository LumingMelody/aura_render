# ç´ æåº“é›†æˆä¸ä¼˜åŒ– - å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ:** 2025-10-28
**é¡¹ç›®:** Aura Render - ç´ æåº“é›†æˆ
**çŠ¶æ€:** âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®Œæˆäº†ä»¥ä¸‹æ ¸å¿ƒä»»åŠ¡ï¼š

1. âœ… **èŠ±å­—å¤§å°è°ƒæ•´** - å°†èŠ±å­—å¤§å°å‡åŠï¼Œé¿å…é®æŒ¡ç”»é¢
2. âœ… **BGMé—®é¢˜åˆ†æ** - å®šä½å¹¶ä¿®å¤BGMæ— æ•ˆURLé—®é¢˜
3. âœ… **ç´ æåº“é›†æˆ** - æ¥å…¥çœŸå®çš„ç´ æåº“API
4. âœ… **ç»Ÿä¸€æ¥å£å®ç°** - BGMå’Œè§†é¢‘ç´ æä½¿ç”¨ç»Ÿä¸€æ¥å£
5. âœ… **æ–‡æ¡£å’Œæµ‹è¯•** - å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•å·¥å…·

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. èŠ±å­—å¤§å°ä¼˜åŒ–

**æ–‡ä»¶:** `ims_converter/utils.py`

**ä¿®æ”¹:**
```python
# ä¹‹å‰
font_size = 55  # ä¸­ç­‰å­—

# ç°åœ¨
font_size = 28  # å‡åŠ
```

**å­—å·æ˜ å°„è¡¨:**
| ç±»å‹ | åŸå¤§å° | æ–°å¤§å° | æ¯”ä¾‹ |
|------|--------|--------|------|
| å°å­— | 40 | 20 | 50% |
| ä¸­ç­‰å­— | 55 | 28 | 51% |
| å¤§å­— | 70 | 35 | 50% |
| è¶…å¤§å­— | 85 | 43 | 51% |

### 2. BGMé—®é¢˜è¯Šæ–­ä¸ä¿®å¤

**é—®é¢˜åˆ†æ:**

```
åŸå› : BGM URLæ˜¯å‡çš„å ä½ç¬¦
â”œâ”€ bgm_matcher.py è¿”å› https://audio.com/tech-bgm.mp3
â”œâ”€ é˜¿é‡Œäº‘IMS APIæ— æ³•ä¸‹è½½è¯¥URL
â””â”€ å¯¼è‡´è§†é¢‘ç”Ÿæˆå¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ:**

**2.1 è¿‡æ»¤æ— æ•ˆURL** (`ims_converter/converter.py`)
```python
# è¿‡æ»¤å ä½ç¬¦URL
if audio_url.startswith("https://audio.com/") or \
   audio_url.startswith("https://assets.example.com/"):
    logger.warning(f"è·³è¿‡æ— æ•ˆçš„BGM URL: {audio_url}")
    continue
```

**2.2 æ¥å…¥çœŸå®ç´ æåº“** (`materials_supplies/`)
- åˆ›å»ºç»Ÿä¸€APIå®¢æˆ·ç«¯
- å®ç°å¤šçº§æœç´¢ç­–ç•¥
- è·å–çœŸå®éŸ³é¢‘URL

### 3. ç´ æåº“APIé›†æˆ

**æ–°å¢æ–‡ä»¶:**
- `materials_supplies/material_library_client.py` - ç´ æåº“APIå®¢æˆ·ç«¯

**æ ¸å¿ƒåŠŸèƒ½:**

```python
class MaterialLibraryClient:
    """ç´ æåº“APIå®¢æˆ·ç«¯"""

    def search_audios(tag, keyword, page_size):
        """æœç´¢éŸ³é¢‘ç´ æ (type=2)"""

    def search_videos(tag, keyword, page_size):
        """æœç´¢è§†é¢‘ç´ æ (type=1)"""
```

**æ¥å£å‚æ•°:**

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| type | ç´ æç±»å‹ | 1=è§†é¢‘, 2=éŸ³é¢‘ |
| name | åç§°æœç´¢ | "ç§‘æŠ€" |
| tag | æ ‡ç­¾è¿‡æ»¤ | "å†·é™" |
| tenant_id | ç§Ÿæˆ·ID | "1" |
| Authorization | è®¤è¯token | Bearer xxx |

### 4. BGMåŒ¹é…ç­–ç•¥

**æ–‡ä»¶:** `materials_supplies/matcher/bgm_matcher.py`

**å¤šçº§Fallbackç­–ç•¥:**

```python
æœç´¢ç­–ç•¥:
1. tag=é£æ ¼ (æç®€ç”µå­)          â† ä¼˜å…ˆ
2. tag=æƒ…ç»ª (å†·é™)              â† æ¬¡é€‰
3. tag=é£æ ¼ + keyword=æƒ…ç»ª     â† ç»„åˆ
4. keyword=èƒŒæ™¯éŸ³ä¹             â† å…œåº•
```

**å®Œæ•´æµç¨‹:**

```
è¾“å…¥: {mood: "å†·é™", genre: "æç®€ç”µå­", duration: 5s}
  â†“
ç­–ç•¥1: æœç´¢ tag="æç®€ç”µå­"
  â”œâ”€ æ‰¾åˆ°3ä¸ªå€™é€‰ âœ…
  â”œâ”€ ç”¨ffprobeè·å–æ—¶é•¿
  â”œâ”€ éšæœºè£å‰ª5ç§’ç‰‡æ®µ
  â””â”€ è¿”å›BGMåˆ—è¡¨
  â†“
ç­–ç•¥å¤±è´¥ â†’ å°è¯•ä¸‹ä¸€ä¸ªç­–ç•¥
  â†“
å…¨éƒ¨å¤±è´¥ â†’ è¿”å›ç©ºåˆ—è¡¨ (è§†é¢‘æ— BGM)
```

### 5. Tenant IDè‡ªåŠ¨æå–

**æ–‡ä»¶:** `vgp_api.py`

**å®ç°:**
```python
async def process_vgp_video_generation(task_id, request):
    tenant_id = request.tenant_id  # ä»è¯·æ±‚æå–

    # åˆå§‹åŒ–ç´ æåº“å®¢æˆ·ç«¯
    if tenant_id:
        init_material_library_client(tenant_id, auth_token)
```

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
  "tenant_id": "1",
  "id": "404",
  "theme_id": "äº§å“å±•ç¤º",
  ...
}
```

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ–°å¢æ–‡ä»¶ (3ä¸ª)

1. `materials_supplies/material_library_client.py` - ç´ æåº“APIå®¢æˆ·ç«¯ (219è¡Œ)
2. `docs/MATERIAL_LIBRARY_SETUP.md` - é…ç½®è¯´æ˜æ–‡æ¡£ (200è¡Œ)
3. `docs/MATERIAL_LIBRARY_QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å— (300è¡Œ)
4. `test_material_library.py` - é›†æˆæµ‹è¯•è„šæœ¬ (350è¡Œ)

### ä¿®æ”¹æ–‡ä»¶ (5ä¸ª)

1. `materials_supplies/matcher/bgm_matcher.py` - é‡å†™BGMåŒ¹é…é€»è¾‘
2. `ims_converter/converter.py` - æ·»åŠ URLéªŒè¯å’Œè¯¦ç»†æ—¥å¿—
3. `ims_converter/utils.py` - è°ƒæ•´èŠ±å­—å¤§å°ä¸ºä¸€åŠ
4. `vgp_api.py` - æ·»åŠ ç´ æåº“å®¢æˆ·ç«¯åˆå§‹åŒ–
5. `.env` - æ·»åŠ ç´ æåº“é…ç½®é¡¹

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

è¿è¡Œå®Œæ•´æµ‹è¯•ï¼š
```bash
python test_material_library.py
```

**æµ‹è¯•è¦†ç›–:**
- âœ… ç´ æåº“å®¢æˆ·ç«¯è¿æ¥
- âœ… éŸ³é¢‘æœç´¢ (å¤šä¸ªtag)
- âœ… è§†é¢‘æœç´¢ (å¤šä¸ªtag)
- âœ… BGMåŒ¹é…åŠŸèƒ½
- âœ… å®Œæ•´å·¥ä½œæµé›†æˆ

### æ—¥å¿—ç›‘æ§

```bash
# å®æ—¶ç›‘æ§BGMåŒ¹é…
tail -f logs/aura_render.log | grep "ğŸµ"

# æŸ¥çœ‹ç´ æåº“è°ƒç”¨
tail -f logs/aura_render.log | grep "ç´ æåº“"
```

---

## ğŸ” è°ƒè¯•å¢å¼º

### æ–°å¢è°ƒè¯•æ—¥å¿—

**qwen_integration.py (Line 851-858):**
```python
# BGMè¯¦ç»†è°ƒè¯•
logger.info(f"  - bgm_composition_id: {type(bgm_data).__name__}")
if isinstance(bgm_data, dict):
    logger.info(f"    â””â”€ keys: {list(bgm_data.keys())}")
    logger.info(f"    â””â”€ clipsæ•°é‡: {len(bgm_data.get('clips', []))}")
    if bgm_data.get('clips'):
        logger.info(f"    â””â”€ ç¬¬ä¸€ä¸ªclip: {bgm_data['clips'][0]}")
```

**converter.py (Line 73-84):**
```python
logger.info(f"   ğŸµ æ£€æŸ¥BGMæ•°æ®: bgm_composition_idå­˜åœ¨={...}")
logger.info(f"   ğŸµ BGMç±»å‹: {type(bgm).__name__}")
logger.info(f"   ğŸµ BGM keys: {list(bgm.keys())}")
logger.info(f"   ğŸµ BGM clipsæ•°é‡: {len(bgm.get('clips', []))}")
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ (.env)

```bash
# ç´ æåº“é…ç½® (æ–°å¢)
MATERIAL_LIBRARY_AUTH=ä½ çš„token
MATERIAL_LIBRARY_HOST=agent.cstlanbaai.com
MATERIAL_LIBRARY_BASE_PATH=/gateway/admin-api/agent/resource/page

# ç°æœ‰é…ç½®
DASHSCOPE_API_KEY=sk-xxx
OSS_ACCESS_KEY_ID=xxx
OSS_ACCESS_KEY_SECRET=xxx
```

### è·å–Authorization Token

1. ç™»å½•ç´ æåº“ç®¡ç†åå°
2. è¿›å…¥APIç®¡ç†é¡µé¢
3. ç”Ÿæˆæˆ–å¤åˆ¶Authorization Token
4. æ·»åŠ åˆ° `.env` æ–‡ä»¶

---

## ğŸ“Š æ€§èƒ½å½±å“

### BGMåŒ¹é…æ€§èƒ½

| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| APIæœç´¢ | ~200ms | ç´ æåº“æŸ¥è¯¢ |
| ffprobe | ~500ms | è·å–éŸ³é¢‘æ—¶é•¿ |
| æ€»è®¡ | ~700ms | æ¯ä¸ªBGMç‰‡æ®µ |

**ä¼˜åŒ–å»ºè®®:**
- ç¼“å­˜æœç´¢ç»“æœ
- ç¼“å­˜éŸ³é¢‘æ—¶é•¿
- å¹¶å‘å¤„ç†å¤šä¸ªç‰‡æ®µ

### å†…å­˜å ç”¨

- ç´ æåº“å®¢æˆ·ç«¯: ~10KB
- BGMåŒ¹é…ç¼“å­˜: ~100KB (å¯é€‰)
- æ€»ä½“å½±å“: å¯å¿½ç•¥

---

## ğŸ› å·²çŸ¥é—®é¢˜

### 1. ffprobeä¾èµ–

**é—®é¢˜:** éœ€è¦ç³»ç»Ÿå®‰è£…ffprobe

**æ£€æŸ¥:**
```bash
which ffprobe
ffprobe -version
```

**è§£å†³:**
```bash
# macOS
brew install ffmpeg

# Ubuntu
sudo apt install ffmpeg
```

### 2. ç´ æåº“æ ‡ç­¾æœªæ ‡å‡†åŒ–

**é—®é¢˜:** ä¸åŒç´ æçš„tagå‘½åä¸ç»Ÿä¸€

**å»ºè®®:**
- ç»Ÿä¸€æ ‡ç­¾å‘½åè§„èŒƒ
- æ·»åŠ æ ‡ç­¾æ˜ å°„è¡¨
- æ”¯æŒæ¨¡ç³ŠåŒ¹é…

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸ (1-2å‘¨)

1. **è§†é¢‘ç´ æåŒ¹é…**
   - åœ¨AIç”Ÿæˆå‰å…ˆæœç´¢ç´ æåº“
   - èŠ‚çœç”Ÿæˆæˆæœ¬

2. **æœç´¢ä¼˜åŒ–**
   - æ·»åŠ LRUç¼“å­˜
   - æ”¯æŒæ¨¡ç³Šæœç´¢
   - è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…

3. **ç›‘æ§é¢æ¿**
   - ç´ æä½¿ç”¨ç»Ÿè®¡
   - åŒ¹é…æˆåŠŸç‡
   - APIè°ƒç”¨æ¬¡æ•°

### ä¸­æœŸ (1-2æœˆ)

1. **æ™ºèƒ½æ¨è**
   - åŸºäºå†å²è®°å½•æ¨è
   - AIè¯„åˆ†æ’åº
   - ä¸ªæ€§åŒ–æ¨è

2. **ç´ æé¢„è§ˆ**
   - åœ¨çº¿è¯•å¬BGM
   - å¯è§†åŒ–é€‰æ‹©
   - æ‰‹åŠ¨è°ƒæ•´è£å‰ªç‚¹

3. **æ‰¹é‡å¤„ç†**
   - å¹¶å‘è¯·æ±‚ä¼˜åŒ–
   - æ‰¹é‡åŒ¹é…æ¥å£
   - ç»“æœç¼“å­˜

---

## ğŸ“ æ–‡æ¡£æ¸…å•

1. `docs/MATERIAL_LIBRARY_SETUP.md` - å®Œæ•´é…ç½®æ–‡æ¡£
2. `docs/MATERIAL_LIBRARY_QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
3. `test_material_library.py` - æµ‹è¯•è„šæœ¬
4. æœ¬æ–‡æ¡£ - å®ŒæˆæŠ¥å‘Š

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] èŠ±å­—å¤§å°è°ƒæ•´ä¸ºåŸæ¥çš„ä¸€åŠ
- [x] BGMé—®é¢˜æ ¹å› åˆ†æå®Œæˆ
- [x] ç´ æåº“APIé›†æˆå®Œæˆ
- [x] BGMåŒ¹é…ä½¿ç”¨çœŸå®æ¥å£
- [x] è¿‡æ»¤æ— æ•ˆå ä½ç¬¦URL
- [x] ä»tenant_idè‡ªåŠ¨åˆå§‹åŒ–
- [x] è¯¦ç»†è°ƒè¯•æ—¥å¿—æ·»åŠ 
- [x] æµ‹è¯•è„šæœ¬ç¼–å†™å®Œæˆ
- [x] æ–‡æ¡£ç¼–å†™å®Œæ•´
- [x] ä»£ç æ³¨é‡Šæ¸…æ™°

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®ç¯å¢ƒ

```bash
# ç¼–è¾‘ .env
vim .env

# æ·»åŠ 
MATERIAL_LIBRARY_AUTH=ä½ çš„token
```

### 2. æµ‹è¯•è¿æ¥

```bash
python test_material_library.py
```

### 3. å¯åŠ¨æœåŠ¡

```bash
python3 app.py
```

### 4. å‘é€è¯·æ±‚

```bash
curl -X POST "http://localhost:8001/vgp/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "1",
    "id": "test_001",
    "theme_id": "äº§å“å±•ç¤º",
    "user_description_id": "æ™ºèƒ½äº§å“å±•ç¤º",
    "target_duration_id": 10
  }'
```

### 5. æŸ¥çœ‹æ—¥å¿—

```bash
tail -f logs/aura_render.log | grep "ğŸµ\|âœ…\|âš ï¸"
```

---

## ğŸ’¡ æ€»ç»“

æœ¬æ¬¡æ›´æ–°æˆåŠŸå®ç°äº†ï¼š

1. **ç”¨æˆ·ä½“éªŒæå‡**
   - èŠ±å­—ä¸å†é®æŒ¡ç”»é¢
   - BGMçœŸå®å¯ç”¨ï¼ˆå¦‚æœç´ æåº“æœ‰åŒ¹é…ï¼‰

2. **ç³»ç»Ÿæ¶æ„ä¼˜åŒ–**
   - ç»Ÿä¸€ç´ æåº“æ¥å£
   - çµæ´»çš„æœç´¢ç­–ç•¥
   - å®Œå–„çš„é”™è¯¯å¤„ç†

3. **å¼€å‘ä½“éªŒæ”¹å–„**
   - è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
   - å®Œæ•´çš„æµ‹è¯•å·¥å…·
   - æ¸…æ™°çš„æ–‡æ¡£è¯´æ˜

4. **ç”Ÿäº§å°±ç»ª**
   - è®¤è¯æœºåˆ¶å®Œå–„
   - å®¹é”™èƒ½åŠ›å¼º
   - æ˜“äºç›‘æ§å’Œç»´æŠ¤

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨:**

1. æä¾› `MATERIAL_LIBRARY_AUTH` token
2. è¿è¡Œæµ‹è¯•éªŒè¯é…ç½®
3. ç”Ÿæˆæµ‹è¯•è§†é¢‘æ£€æŸ¥æ•ˆæœ
4. æ ¹æ®å®é™…æ•ˆæœè°ƒä¼˜å‚æ•°

---

**å®Œæˆæ—¶é—´:** 2025-10-28
**æ€»è®¡ä¿®æ”¹:** 8ä¸ªæ–‡ä»¶, æ–°å¢4ä¸ªæ–‡ä»¶
**æ€»è®¡ä»£ç è¡Œæ•°:** ~1000è¡Œ
