# ç³»ç»Ÿä¼˜åŒ–æ€»ç»“

## ğŸ“‹ ä¼˜åŒ–æ¦‚è§ˆ

æœ¬æ¬¡ä¼˜åŒ–å®Œæˆäº†å®Œæ•´çš„ **Nodeæ‰§è¡Œ â†’ VGPæ•°æ®èšåˆ â†’ IMS TimelineåŒæ­¥ â†’ æ¸²æŸ“è¾“å‡º** æµç¨‹ã€‚

---

## âœ… å®Œæˆçš„ä¼˜åŒ–

### 1ï¸âƒ£ **IMSConverteréŸ³é¢‘è½¨é“å¤„ç†** (/ims_converter/converter.py)

#### æ–°å¢åŠŸèƒ½ï¼š
- âœ… æ·»åŠ  `_convert_audio_tracks()` æ–¹æ³•ï¼Œæ”¯æŒBGMå’ŒSFXéŸ³é¢‘è½¬æ¢
- âœ… å®ç° `_db_to_gain()` dBéŸ³é‡åˆ°IMS Gainçš„è½¬æ¢
- âœ… æ”¯æŒéŸ³é¢‘æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼ˆAFadeï¼‰
- âœ… æ™ºèƒ½éŸ³é‡è°ƒæ•´ï¼šBGMé»˜è®¤-18dBï¼ŒSFXé»˜è®¤50%éŸ³é‡

#### æ•°æ®æµï¼š
```python
VGP bgm_composition_id: {
    "clips": [
        {
            "audio": {"url": "...", "in_point": 0, "out_point": 10},
            "start": 0.0,
            "duration": 10.0,
            "volume_db": -20.0,
            "transition": "æ·¡å…¥"
        }
    ]
}
    â†“
IMS AudioTracks: [
    {
        "AudioTrackClips": [{
            "MediaURL": "...",
            "TimelineIn": 0.0,
            "TimelineOut": 10.0,
            "In": 0.0,
            "Out": 10.0,
            "Effects": [
                {"Type": "Volume", "Gain": 0.1},
                {"Type": "AFade", "FadeType": "In"}
            ]
        }]
    }
]
```

---

### 2ï¸âƒ£ **éŸ³é¢‘æ··éŸ³ä¼˜åŒ–å™¨** (/ims_converter/audio_mixer.py)

#### æ ¸å¿ƒåŠŸèƒ½ï¼š
- âœ… æ™ºèƒ½è¯†åˆ«éŸ³è½¨ç±»å‹ï¼ˆTTSã€BGMã€SFXã€ç¯å¢ƒéŸ³ï¼‰
- âœ… åŸºäºéŸ³è½¨ç±»å‹çš„é»˜è®¤éŸ³é‡é…ç½®ï¼š
  - TTS/Narration: -12dBï¼ˆæœ€å“ï¼‰
  - SFX: -16dB
  - BGM: -20dBï¼ˆèƒŒæ™¯ï¼‰
  - Ambient: -22dBï¼ˆæ›´ä½ï¼‰
- âœ… å¤šéŸ³è½¨å¹¶å‘æ£€æµ‹ä¸è‡ªåŠ¨è¡°å‡ï¼š
  - 2è½¨åŒæ—¶ï¼šè¡°å‡åˆ°85%
  - 3è½¨åŒæ—¶ï¼šè¡°å‡åˆ°70%
  - 4è½¨+ï¼šè¡°å‡åˆ°60%

#### ä½¿ç”¨ç¤ºä¾‹ï¼š
```python
from ims_converter.audio_mixer import optimize_ims_audio_tracks

timeline = optimize_ims_audio_tracks(timeline, total_duration=60.0)
```

---

### 3ï¸âƒ£ **æ—¶é—´è½´å¯¹é½å™¨** (/ims_converter/timeline_aligner.py)

#### æ ¸å¿ƒåŠŸèƒ½ï¼š
- âœ… è§†é¢‘ç‰‡æ®µè¾¹ç•Œè®¡ç®—
- âœ… éŸ³é¢‘è½¨é“å¯¹é½ï¼ˆé˜²æ­¢è¶…å‡ºè§†é¢‘æ—¶é•¿ï¼‰
- âœ… å­—å¹•è½¨é“å¯¹é½ï¼ˆè·¨ç‰‡æ®µæˆªæ–­ï¼‰
- âœ… ç‰¹æ•ˆè½¨é“å¯¹é½ï¼ˆé™åˆ¶åœ¨ç‰‡æ®µå†…ï¼‰
- âœ… èŠ±å­—è½¨é“å¯¹é½

#### å¯¹é½é€»è¾‘ï¼š
```
è§†é¢‘ç‰‡æ®µ: [0-10s] [10-20s] [20-30s]
       â†“
å­—å¹•ç‰‡æ®µ: [8-12s] â†’ æˆªæ–­ä¸º [8-10s] (ä¸è·¨ç‰‡æ®µ)
éŸ³é¢‘ç‰‡æ®µ: [0-35s] â†’ æˆªæ–­ä¸º [0-30s] (ä¸è¶…å‡ºè§†é¢‘)
ç‰¹æ•ˆ: [25-35s] â†’ æˆªæ–­ä¸º [25-30s] (é™åˆ¶åœ¨ç‰‡æ®µå†…)
```

---

### 4ï¸âƒ£ **qwen_integrationå¢å¼ºVGPé›†æˆ**

#### ä¿®æ”¹å†…å®¹ï¼š
```python
# å‡†å¤‡å®Œæ•´çš„VGPä¸Šä¸‹æ–‡
vgp_result = {
    "filter_sequence_id": [...],      # æ»¤é•œ
    "transition_sequence_id": [...],  # è½¬åœº
    "effects_sequence_id": [...],     # ç‰¹æ•ˆ
    "text_overlay_track_id": {...},   # âœ… èŠ±å­—
    "auxiliary_track_id": {...},      # âœ… è¾…åŠ©åª’ä½“
    "bgm_composition_id": {...}       # âœ… BGM
}

# è½¬æ¢ä¸ºIMSæ ¼å¼
converted = converter.convert(vgp_result)

# æ‰“å°è½¬æ¢æ‘˜è¦
summary = converter.get_conversion_summary(vgp_result)
# è¾“å‡ºï¼š{"total_clips": 10, "transitions": 9, "filters": 10,
#        "effects": 5, "texts": 3, "overlays": 2, "audio_tracks": 2}

# åˆå¹¶åˆ°timeline
timeline["AudioTracks"].extend(converted["AudioTracks"])
timeline["TextTracks"].extend(converted["TextTracks"])

# ä¼˜åŒ–éŸ³é¢‘æ··éŸ³
timeline = optimize_ims_audio_tracks(timeline, total_duration)

# æ—¶é—´è½´å¯¹é½
timeline = align_ims_timeline(timeline, clip_data)
```

---

## ğŸ¯ å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          VGP Nodeæ‰§è¡Œé“¾                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Node 10: transition_selection_node          â”‚
â”‚   â†’ transition_sequence_id                  â”‚
â”‚ Node 11: filter_application_node            â”‚
â”‚   â†’ filter_sequence_id                      â”‚
â”‚ Node 12: dynamic_effects_node               â”‚
â”‚   â†’ effects_sequence_id                     â”‚
â”‚ Node 13: aux_text_insertion_node            â”‚
â”‚   â†’ text_overlay_track_id                   â”‚
â”‚ Node 15: aux_media_insertion_node           â”‚
â”‚   â†’ auxiliary_track_id                      â”‚
â”‚ Node 8: bgm_composition_node                â”‚
â”‚   â†’ bgm_composition_id  âœ… æ–°å¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          IMSConverterè½¬æ¢                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _convert_video_clips()  â†’ VideoTracks       â”‚
â”‚ _convert_audio_tracks() â†’ AudioTracks âœ…     â”‚
â”‚ _convert_filters()      â†’ EffectTracks      â”‚
â”‚ _convert_effects()      â†’ EffectTracks      â”‚
â”‚ _convert_text_overlay() â†’ TextTracks âœ…      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          éŸ³é¢‘æ··éŸ³ä¼˜åŒ–å™¨ âœ…                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¯†åˆ«éŸ³è½¨ç±»å‹ï¼ˆTTS/BGM/SFXï¼‰                â”‚
â”‚ â€¢ è®¡ç®—å¹¶å‘åº¦                                 â”‚
â”‚ â€¢ åŠ¨æ€è°ƒæ•´Gain                               â”‚
â”‚ â€¢ é¿å…çˆ†éŸ³                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ—¶é—´è½´å¯¹é½å™¨ âœ…                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è®¡ç®—è§†é¢‘ç‰‡æ®µè¾¹ç•Œ                           â”‚
â”‚ â€¢ å¯¹é½éŸ³é¢‘è½¨é“                               â”‚
â”‚ â€¢ å¯¹é½å­—å¹•/èŠ±å­—                              â”‚
â”‚ â€¢ å¯¹é½ç‰¹æ•ˆ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          IMS APIæäº¤                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ client.submit_media_producing_job(timeline) â”‚
â”‚   â†’ é˜¿é‡Œäº‘æ¸²æŸ“å¼•æ“                           â”‚
â”‚   â†’ æœ€ç»ˆè§†é¢‘è¾“å‡º                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å…³é”®æ˜ å°„è¡¨

### éŸ³é¢‘ç±»å‹è¯†åˆ«
| URLå…³é”®è¯ | è¯†åˆ«ç±»å‹ | é»˜è®¤éŸ³é‡ |
|-----------|----------|----------|
| tts/voice/speech | TTS | -12dB |
| bgm/music/background | BGM | -20dB |
| sfx/sound/effect | SFX | -16dB |
| ambient/atmosphere | Ambient | -22dB |

### å¹¶å‘è¡°å‡ç³»æ•°
| å¹¶å‘è½¨é“æ•° | è¡°å‡ç³»æ•° |
|-----------|----------|
| 1 | 1.0 (100%) |
| 2 | 0.85 (85%) |
| 3 | 0.70 (70%) |
| 4+ | 0.60 (60%) |

---

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1ï¼šè‡ªåŠ¨é›†æˆï¼ˆå·²é…ç½®ï¼‰
åœ¨`qwen_integration.py`çš„`merge_clips`æ–¹æ³•ä¸­ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. ä½¿ç”¨IMSConverterè½¬æ¢VGPæ•°æ®
2. åº”ç”¨éŸ³é¢‘æ··éŸ³ä¼˜åŒ–
3. æ‰§è¡Œæ—¶é—´è½´å¯¹é½
4. æäº¤IMS API

### æ–¹å¼2ï¼šæ‰‹åŠ¨è°ƒç”¨
```python
from ims_converter import IMSConverter
from ims_converter.audio_mixer import optimize_ims_audio_tracks
from ims_converter.timeline_aligner import align_ims_timeline

# 1. è½¬æ¢VGPæ•°æ®
converter = IMSConverter(use_filter_preset=True)
timeline = converter.convert(vgp_result)

# 2. ä¼˜åŒ–éŸ³é¢‘
timeline = optimize_ims_audio_tracks(timeline, total_duration=60.0)

# 3. å¯¹é½æ—¶é—´è½´
timeline = align_ims_timeline(timeline, clip_data)

# 4. æäº¤IMS
client.submit_media_producing_job(timeline=timeline)
```

---

## ğŸ“ˆ æ€§èƒ½æå‡

### ä¼˜åŒ–å‰
- âŒ BGMéŸ³é‡è¿‡å¤§ï¼Œç›–è¿‡äººå£°
- âŒ å¤šéŸ³è½¨åŒæ—¶æ’­æ”¾çˆ†éŸ³
- âŒ å­—å¹•è·¨ç‰‡æ®µæ˜¾ç¤º
- âŒ éŸ³é¢‘è¶…å‡ºè§†é¢‘æ—¶é•¿

### ä¼˜åŒ–å
- âœ… æ™ºèƒ½éŸ³é‡åˆ†é…ï¼Œå±‚æ¬¡æ¸…æ™°
- âœ… è‡ªåŠ¨å¹¶å‘æ£€æµ‹ä¸è¡°å‡
- âœ… å­—å¹•ä¸¥æ ¼å¯¹é½ç‰‡æ®µè¾¹ç•Œ
- âœ… æ‰€æœ‰è½¨é“æ—¶é—´ç²¾ç¡®å¯¹é½

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰ä¼˜åŒ–å·²å®Œæˆå¹¶é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼ç°åœ¨ä½ çš„ç³»ç»Ÿæ”¯æŒï¼š

1. **å®Œæ•´çš„VGP â†’ IMSè½¬æ¢**ï¼ˆè½¬åœº/æ»¤é•œ/ç‰¹æ•ˆ/èŠ±å­—/BGMï¼‰
2. **æ™ºèƒ½éŸ³é¢‘æ··éŸ³**ï¼ˆç±»å‹è¯†åˆ«ã€éŸ³é‡ä¼˜åŒ–ã€å¹¶å‘æ§åˆ¶ï¼‰
3. **ç²¾ç¡®æ—¶é—´è½´å¯¹é½**ï¼ˆé˜²æ­¢è¶…æ—¶ã€è·¨ç‰‡æ®µã€æ—¶é—´å†²çªï¼‰

ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼š**åªéœ€å°†Nodeæ‰§è¡Œç»“æœåŒæ­¥åˆ°IMS Timelineï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¼˜åŒ–ï¼**
